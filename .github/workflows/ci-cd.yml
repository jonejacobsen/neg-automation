# .github/workflows/ci-cd.yml
name: ci-cd

on:
  pull_request:

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1.  Test job
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    runs-on: ubuntu-latest
    steps:
      # 1-A  Check out the PR branch
      - uses: actions/checkout@v4

      # 1-B  Install deps (lock-file-aware) and run tests
      - name: Install dependencies & run tests
        run: |
          # If the repo contains a Node project with tests, run them.
          if [ -f package.json ]; then
            if [ -f package-lock.json ]; then
              echo "ğŸ”’  Lock-file found â€“ running npm ci"
              npm ci
            else
              echo "âš ï¸  No lock-file â€“ falling back to npm install"
              npm install --no-audit --no-fund
            fi

            if [ -f package.json ] && jq -e '.scripts.test' package.json > /dev/null; then
              echo "ğŸ§ª  Running test script"
              npm test
            else
              echo "â„¹ï¸  No test script defined â€“ skipping tests"
            fi
          else
            echo "â„¹ï¸  No package.json â€“ skipping Node tests"
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2.  Deploy job
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    # Run only **after** PR is merged and tests (if any) have passed
    if: github.event.pull_request.merged == true
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Zapier bundle (if present)
        env:
          ZAPIER_KEY: ${{ secrets.ZAPIER_KEY }}
        run: |
          if [ -f zapier.zap ]; then
            echo "ğŸš€  Deploying zapier.zap"
            npx zapier push --yes --api-key "$ZAPIER_KEY"
          else
            echo "â„¹ï¸  No Zapier bundle found â€“ nothing to deploy."
          fi
